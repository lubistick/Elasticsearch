# Elasticsearch

Полнотекстовый поиск - такой поиск, который позволяет искать текст в документах по ключевым словам или фразам.
При полнотекстовом поиске анализируется содержимое текста и в результате выдаются более релевантные документы.

Elasticsearch - это хранилище документов с возможностью создавать полнотекстовые индексы для последующего поиска.
Чаще всего используется в качестве поискового движка.
Основан на библиотеке `Apache Lucene`.


## Основные понятия

- `Индексы` предназначены для группировки данных в логические структуры.
У нас может быть индекс по фильмам, индекс по товарам или какой-то еще.
- `Документы` - это записи в самом индексе.
- `Запросы` предназначены для поиска и фильтрации в индексе.


## Запуск

Запустим кластер Elastic:
```sh
docker run --name elastic-demo -p 9200:9200 -e "discovery.type=single-node" -e "xpack.security.enabled=false" elasticsearch:9.2.4
```

Переменные:
- `discovery.type=single-node` - кластер, состоящий из одного узла
- `xpack.security.enabled=false` - отключаем `https`

Проверим:

```sh
curl http://localhost:9200

{
  "name" : "64f473f36498",
  "cluster_name" : "docker-cluster",
  "cluster_uuid" : "YgotWteFQsGkxSw_FdhiZw",
  "version" : {
    "number" : "9.2.4",
    "build_flavor" : "default",
    "build_type" : "docker",
    "build_hash" : "dfc5c38614c29a598e132c035b66160d3d350894",
    "build_date" : "2026-01-08T22:07:25.170027027Z",
    "build_snapshot" : false,
    "lucene_version" : "10.3.2",
    "minimum_wire_compatibility_version" : "8.19.0",
    "minimum_index_compatibility_version" : "8.0.0"
  },
  "tagline" : "You Know, for Search"
}
```


## API Elasticsearch

Взаимодействие с Elasticsearch происходит по http протоколу командами `GET`, `PUT`, `POST` и другими в зависимости от выполняемой операции.
Мы можем обращаться к Elasticsearch с помощью утилиты командной строки `curl` или через удобный графический иннерфейс как `Postman`.


### Индекс

Индекс в Elasticsearch представляет собой структуру подобную таблице в реляционной базе данных.
Индекс используется для хранения, поиска и анализа данных.
Индекс в Elasticsearch можно не создавать явно - если добавить документ в несуществующий индекс, Elasticsearch автоматически создаст этот индекс.
Однако, лучше создавать его самостоятельно, так мы получаем больший контроль над структурой данных,
можем уточнить, какие анализаторы будут использованы, какие поля стоит индексировать и многое другое.

Например, мы храним информацию о товарах в магазине.
Создадим индекс:

```sh
curl -X PUT http://localhost:9200/product_index \
  -H "Content-Type: application/json" \
  -d '{
    "mappings": {
      "properties": {
        "title": {
          "type": "text",
          "analyzer": "russian"
        },
        "price": {
          "type": "float"
        },
        "available": {
          "type": "boolean"
        }
      }
    }
  }'


{"acknowledged":true,"shards_acknowledged":true,"index":"product_index"}
```

- индекс создается через `PUT` запрос
- название индекса указывается в адресной строке сразу после домена сервера, в нашем случае это `product_index`
- мы определили поля и типы данных в ключе `mappings` - название (`title`), цену (`price`) и доступность на складе (`available`)
- названия товаров хранятся на русском языке, поэтому выбираем русский анализатор (`russian`), он доступен из коробки Elasticsearch
- в ответе поле `acknowledged` со значением `true` означает, что индекс успешно создан


### Документ

Теперь добавим документы в индекс:

```sh
curl -X PUT http://localhost:9200/product_index/_doc/1 \
  -H "Content-Type: application/json" \
  -d '{
    "title": "Беспроводные наушники",
    "price": 49.99,
    "available": true
  }'


{"_index":"product_index","_id":"1","_version":1,"result":"created","_shards":{"total":2,"successful":1,"failed":0},"_seq_no":0,"_primary_term":1}
```

- документ добавляет в индекс с помощью `PUT` запроса
- в урле после указываем в какой индекс добавляем документ (`product_index`), затем пишем `_doc`, затем указываем ID документа (`1`)
- в теле запроса указываем поля товара, которые мы хотим сохранить
- в ответе поле `result` со значением `created` - был создан новый документ

Если мы отправим запрос по этому же пути, но изменим цену на `59.99`, то в ответе увидим `result` со значением `updated`:

```sh
curl -X PUT http://localhost:9200/product_index/_doc/1 \
  -H "Content-Type: application/json" \
  -d '{
    "title": "Беспроводные наушники",
    "price": 59.99,
    "available": true
  }'

{"_index":"product_index","_id":"1","_version":2,"result":"updated","_shards":{"total":2,"successful":1,"failed":0},"_seq_no":1,"_primary_term":1}
```

В ответе также видим, что версия документа обновилась (поле `_version` со значением `2`).
Т.е. в результате запроса был обновлен существующий документ, а не создан новый.

Одна и та же команда может как создавать документ, так и обновлять его.
Это бывает удобно, однако у такого поведения есть и обратная сторона - мы можем случайно обновить или перезатереть какой-либо документ данными, сами того не заметив.
